<!doctype html><html>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<title> Mysql M2B in Action with Docker &#183; 随笔 </title>
<link rel=stylesheet href=https://yuguo.im/css/slim.css>
<link rel=stylesheet href=https://yuguo.im/css/highlight.min.css>
<link rel=stylesheet href=https://yuguo.im/css/sspfont.css>
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro" rel=stylesheet type=text/css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=/favicon.ico>
<link href rel=alternate type=application/rss+xml title=随笔>
</head>
<body>
<div class=container>
<div class=header>
<h1 class=site-title><a href=https://yuguo.im/>随笔</a></h1>
<p class=site-tagline>Stay hungry. Stay foolish.</p>
<div class=nav>
<a class=nav-btn href=#>
<span class="ci ci-burger"></span>
</a>
<ul class=nav-list>
<li class=spacer>&ac;</li>
<li><a href=https://github.com/xiayuguo>Github</a></li>
<li><a href=https://twitter.com/yuguo_im>Twitter</a></li>
<li><a href=/index.xml>RSS</a>
</ul>
</div>
</div>
<div class=content>
<div class=posts>
<div class=post>
<h2 class=post-title><a href=https://yuguo.im/post/2019/mysql-m2b-in-action/>Mysql M2B in Action with Docker</a></h2>
<span class=post-date>Jan 11, 2019 </span>
<div class=post-content>
<blockquote>
<p>M2B: 主主备份(DIY, 哈哈)。最近和数据库备份杠上了，碍于手上没有足够的服务器，于是在一个服务器上使用 Docker 运行两个 Mysql 实例, 下面是主主备份的具体流程, 每一步都不能跳过，请仔细阅读。</p>
</blockquote>
<h3 id=1-运行两个-mysql-实例-mysql-1-和-mysql-2>1. 运行两个 mysql 实例: mysql-1 和 mysql-2</h3>
<blockquote>
<p>确保两台服务器上有相同的数据。</p>
</blockquote>
<pre tabindex=0><code>root@cloud:~# docker run -p 10028:3306 --name mysql-1 -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7
root@cloud:~# docker run -p 10029:3306 --name mysql-2 -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7
</code></pre><h3 id=2-两个实例分别修改配置文件和创建复制账号>2. 两个实例分别修改配置文件和创建复制账号</h3>
<blockquote>
<p>启用二进制日志，选择唯一的服务器ID，并创建复制账号</p>
</blockquote>
<pre tabindex=0><code># mysql-1
# 进入实例 mysql-1
root@cloud:~# docker exec -it mysql-1 bash
# 修改配置文件 my.cnf
root@343cef5a6f96:/# vim /etc/mysql/my.cnf
[mysqld]
server-id                = 128
log_bin                  = mysql-bin
relay-log                = mysql-relay-bin
# replicate-wild-do-table=scheme.%
# replicate-wild-ignore-table=schema.%
log-slave-updates        = on
slave-skip-errors        = all
auto-increment-offset    = 1
auto-increment-increment = 2
binlog_format            = mixed
expire_logs_days         = 10
max_binlog_size          = 100

!includedir /etc/mysql/conf.d/
!includedir /etc/mysql/mysql.conf.d/

# mysql-2
# 进入实例 mysql-2
root@cloud:~# docker exec -it mysql-2 bash
# 修改配置文件 my.cnf
root@343cef5a6f96:/# vim /etc/mysql/my.cnf
[mysqld]
server-id                = 129
log_bin                  = mysql-bin
relay-log                = mysql-relay-bin
# replicate-wild-do-table=scheme.%
# replicate-wild-ignore-table=schema.%
log-slave-updates        = on
slave-skip-errors        = all
auto-increment-offset    = 2
auto-increment-increment = 2
binlog_format            = mixed
expire_logs_days         = 10
max_binlog_size          =

!includedir /etc/mysql/conf.d/
!includedir /etc/mysql/mysql.conf.d/

# 退出容器, 重启两个 mysql 实例
root@cloud:~# docker retart mysql-1 mysql-2
</code></pre><table>
<thead>
<tr>
<th style=text-align:left>参数</th>
<th style=text-align:left>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>server-id</td>
<td style=text-align:left>必须唯一, 建议使用服务器IP</td>
</tr>
<tr>
<td style=text-align:left>log_bin</td>
<td style=text-align:left>开启二进制日志功能，mysql-bin是命名格式，会生成文件名为mysql-bin.000001、mysql-bin.000002等日志文件</td>
</tr>
<tr>
<td style=text-align:left>relay-log</td>
<td style=text-align:left>作为从服务器时的中继日志</td>
</tr>
<tr>
<td style=text-align:left>replicate-wild-do-table=scheme.%</td>
<td style=text-align:left>限制slave只同步那些匹配指定模式的数据表</td>
</tr>
<tr>
<td style=text-align:left>replicate-wild-ignore-table=scheme.%</td>
<td style=text-align:left>是复制过滤选项，可以过滤不需要复制同步的数据库或表，如“scheme.%”指不复制MySQL库下的所有表，依此类推，多个数据库就多写几行</td>
</tr>
<tr>
<td style=text-align:left>log-slave-updates</td>
<td style=text-align:left>slave 将复制事件写进自己的二进制日志</td>
</tr>
<tr>
<td style=text-align:left>slave-skip-errors</td>
<td style=text-align:left>跳过主从复制中遇到的所有错误或指定类型的错误,避免 slave 端复制中断</td>
</tr>
<tr>
<td style=text-align:left>auto-increment-offset=1</td>
<td style=text-align:left>主键自增规则，自增偏移（从1开始），单数</td>
</tr>
<tr>
<td style=text-align:left>auto-increment-increment=2</td>
<td style=text-align:left>主键自增规则，自增因子（每次加2）</td>
</tr>
<tr>
<td style=text-align:left>binlog_format</td>
<td style=text-align:left>主从复制的格式(mixed,statement,row,默认格式是 statement)</td>
</tr>
<tr>
<td style=text-align:left>expire_logs_days = 10</td>
<td style=text-align:left>expire_logs_days = 10日志保存天数：10天</td>
</tr>
</tbody>
</table>
<p><strong>创建复制账号并授权</strong></p>
<pre tabindex=0><code># mysql-1 创建复制账号
root@cloud:~# mysql -uroot -h127.0.0.1 -p123456 -P10028
mysql&gt; GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO repl@'%' IDENTIFIED BY '123456';
Query OK, 0 rows affected, 1 warning (0.01 sec)
mysql&gt; flush privileges;
Query OK, 0 rows affected (0.00 sec)

# mysql-2 创建复制账号
root@cloud:~# mysql -uroot -h127.0.0.1 -p123456 -P10029
mysql&gt; GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO repl@'%' IDENTIFIED BY '123456';
Query OK, 0 rows affected, 1 warning (0.01 sec)
mysql&gt; flush privileges;
Query OK, 0 rows affected (0.00 sec)
</code></pre><h3 id=3将每个主库设置为对方的备库使用新创建的二进制日志开始工作>3.将每个主库设置为对方的备库，使用新创建的二进制日志开始工作</h3>
<blockquote>
<p>将每个主库设置为对方的备库，使用新创建的二进制日志开始工作</p>
</blockquote>
<pre tabindex=0><code># mysql-2 增加 mysql-1 
root@cloud:~# mysql -uroot -h127.0.0.1 -p123456 -P10028
mysql&gt; show master status;
+------------------+----------+
| File             | Position | 
+------------------+----------+
| mysql-bin.000001 |      1080 |
1 row in set (0.00 sec)

root@cloud:~# mysql -uroot -h127.0.0.1 -p123456 -P10029
mysql&gt; CHANGE MASTER TO MASTER_HOST='Your_Server_IP',MASTER_USER='repl', MASTER_PASSWORD='123456', MASTER_PORT=10028, MASTER_LOG_FILE='mysql-bin.00001', MASTER_LOG_POS=1080;
Query OK, 0 rows affected, 1 warning (0.03 sec)
mysql&gt; show master status;
+------------------+----------+
| File             | Position | 
+------------------+----------+
| mysql-bin.000001 |      154 |
1 row in set (0.00 sec)

root@cloud:~# mysql -uroot -h127.0.0.1 -p123456 -P10028
mysql&gt; CHANGE MASTER TO MASTER_HOST='Your_Server_IP',MASTER_USER='repl', MASTER_PASSWORD='123456', MASTER_PORT=10029, MASTER_LOG_FILE='mysql-bin.000001', MASTER_LOG_POS=154;
Query OK, 0 rows affected, 1 warning (0.03 sec)

mysql&gt; start slave;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; show slave status\G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: Your_Server_IP
                  Master_User: repl
                  Master_Port: 10028
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000001
          Read_Master_Log_Pos: 2451
               Relay_Log_File: mysql-relay-bin.000002
                Relay_Log_Pos: 1234
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes

# 看到 Slave_IO_Running 和 Slave_SQL_Running 均为 Yes 表明配置成功
</code></pre><h3 id=4-最后验证主主备份是否成功>4. 最后验证主主备份是否成功</h3>
<pre tabindex=0><code># mysql-1 上创建 schema test table sync
root@cloud:~# mysql -h127.0.0.1 -p123456 -P10028
mysql&gt; CREATE DATABASE test;
mysql&gt; USE test;
mysql&gt; CREATE TABLE `test`.`sync` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(45) NULL COMMENT '名称',
  `remarks` VARCHAR(45) NULL COMMENT '备注',
  PRIMARY KEY (`id`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8;
Query OK, 0 rows affected (0.01 sec)
# 插入一条数据
mysql&gt; insert into sync (`name`, `remarks`) values ('cloud', '平台');
Query OK, 1 row affected (0.00 sec)

# mysql-2 上查询记录和再新增两天记录，验证 id 是否按规则生成
root@cloud:~# mysql -h127.0.0.1 -p123456 -P10029
mysql&gt; USE test;
mysql&gt; select * from sync;
+----+-------+---------+
| id | name  | remarks |
+----+-------+---------+
|  1 | cloud | 平台    |
+----+-------+---------+
1 row in set (0.00 sec)

mysql&gt; insert into sync (`name`, `remarks`) values ('a', 'A');
Query OK, 1 row affected (0.00 sec)

mysql&gt; insert into sync (`name`, `remarks`) values ('b', 'B');
Query OK, 1 row affected (0.01 sec)

mysql&gt; select * from sync;
+----+-------+---------+
| id | name  | remarks |
+----+-------+---------+
|  1 | cloud | 平台    |
|  2 | a     | A       |
|  4 | b     | B       |
+----+-------+---------+
3 rows in set (0.01 sec)

mysql&gt; 此处应该有掌声！！！
</code></pre><p>注: mysql 的镜像中没有 vim , 遇到 vim 不存在时， 需要安装一下</p>
<pre tabindex=0><code>apt-get update &amp;&amp; apt-get install vim -y
</code></pre>
<div>
<p>扫描下方二维码，关注<code style=color:#1aad19;font-weight:700>Feed</code>， 定期推送最新随笔</p>
<img src=http://oss.xiayuguo.com/wechat_qrcode.jpg style=width:215px;height:215px alt="公众号 Feed 二维码">
</div>
</div>
</div>
<div class=pagination>
<a class="btn previous" href=https://yuguo.im/post/2019/docker-run-mysql-error/> Prev</a>
<a class="btn next" href=https://yuguo.im/post/2019/burning/> Next</a>
</div>
</div>
</div>
<div class=footer>
<p>Copyright@<a href=https://yuguo.im/about>Yuguo</a> 2022. Powered by <a href=https://gohugo.io/>Hugo</a>. This theme—Slim—is open sourced on <a href=https://github.com/zhe/hugo-theme-slim>Github</a>.</p>
</div>
</div>
<script src=https://yuguo.im/js/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script>
<script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-161689466-1','auto'),ga('send','pageview')</script>
</body>
</html>